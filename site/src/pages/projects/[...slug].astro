---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const data = entry.data;

// Simple reading time estimate (200 words per minute)
const wordCount = entry.body.split(/\s+/g).length;
const readingTime = Math.ceil(wordCount / 200);

// Load backlinks (reusing same logic, though projects might have fewer backlinks)
let backlinks: Record<string, string[]> = {};
try {
  backlinks = await import('../../generated/backlinks.json').then(m => m.default);
} catch {
  // Backlinks not generated yet
}

const inbound = (backlinks[`/projects/${entry.slug}`] || []);
---

<Layout title={`${data.title} — David A. Lisk`} description={data.summary}>
  <article class="prose prose-lg prose-stone max-w-none prose-headings:font-serif prose-headings:font-medium prose-a:text-accent prose-a:no-underline hover:prose-a:underline dark:prose-invert">
    <header class="not-prose mb-10">
      <h1 class="font-serif text-3xl sm:text-4xl font-medium text-fg mb-3 leading-tight">{data.title}</h1>
      <div class="flex flex-wrap gap-3 text-sm text-muted font-mono items-center">
        {data.updated && <time>{data.updated}</time>}
        <span class="text-muted/40">•</span>
        <span>{readingTime} min read</span>
        {data.tags && data.tags.length > 0 && (
          <div class="flex gap-2 items-center">
            <span class="text-muted/40">•</span>
            {data.tags.map(tag => (
              <a href={`/tags/${tag}`} class="hover:text-fg transition-colors">#{tag}</a>
            ))}
          </div>
        )}
      </div>
    </header>

    <Content />

    {inbound.length > 0 && (
      <div class="not-prose mt-16 pt-8 border-t border-border">
        <h3 class="text-sm font-mono text-muted uppercase tracking-wider mb-4">Linked from</h3>
        <ul class="space-y-2">
          {inbound.map(i => (
            <li>
              <a href={i} class="text-fg hover:text-accent transition-colors border-b border-transparent hover:border-accent">
                {i}
              </a>
            </li>
          ))}
        </ul>
      </div>
    )}
  </article>
</Layout>
