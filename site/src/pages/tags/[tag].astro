---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const writing = await getCollection('writing');
  const projects = await getCollection('projects');
  const allContent = [...writing, ...projects].filter(p => !p.data.draft);

  const uniqueTags = [...new Set(allContent.flatMap(post => post.data.tags || []))];

  return uniqueTags.map(tag => {
    const filteredPosts = allContent.filter(post => post.data.tags?.includes(tag));
    return {
      params: { tag },
      props: { posts: filteredPosts }
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const sortedPosts = posts.sort((a, b) => {
    const dateA = a.data.updated || '';
    const dateB = b.data.updated || '';
    return dateB.localeCompare(dateA);
});
---

<Layout title={`#${tag} â€” David A. Lisk`}>
  <header class="mb-12">
    <h1 class="font-serif text-3xl sm:text-4xl font-medium text-fg mb-4">#{tag}</h1>
    <p class="text-muted max-w-[60ch]">{posts.length} item{posts.length !== 1 ? 's' : ''} tagged with #{tag}.</p>
  </header>

  <div class="space-y-10">
    {sortedPosts.map(p => (
      <article class="group">
        <a href={`/${p.collection}/${p.slug}`} class="block">
          <h2 class="font-serif text-xl sm:text-2xl font-medium text-fg group-hover:text-accent transition-colors mb-2">
            {p.data.title}
          </h2>
          {p.data.summary && (
            <p class="text-muted leading-relaxed max-w-[65ch] mb-2">
              {p.data.summary}
            </p>
          )}
          <div class="flex items-center gap-3 text-sm text-muted/60 font-mono">
             <span class="uppercase tracking-wider text-xs border border-border px-1.5 py-0.5 rounded">{p.collection}</span>
             {p.data.updated && <time>{p.data.updated}</time>}
          </div>
        </a>
      </article>
    ))}
  </div>
</Layout>
